cmake_minimum_required(VERSION 3.15)
project(MeraLang LANGUAGES CXX)

set(CMAKE_CXX_STANDARD 20)
set(CMAKE_EXPORT_COMPILE_COMMANDS ON)

# --- Compiler warnings ---
if(MSVC)
    add_compile_options(/W4 /WX)
else()
    add_compile_options(-Wall -Wextra -Wpedantic -Werror)
endif()

# --- Core sources ---
add_executable(meralang
    src/main.cpp
    src/lexer.cpp
    src/parser.cpp
    src/ir_generator.cpp
    src/nasm_emitter.cpp
    src/llvm_bridge.cpp
    src/capsule_runner.cpp
)

# --- Tools: REPL Debugger UI ---
add_executable(repl_ui
    tools/repl_ui.cpp
    src/capsule_runner.cpp
)

# --- Tests ---
enable_testing()
add_executable(test_capsules
    tests/test_capsules.cpp
    src/capsule_runner.cpp
)
add_test(NAME CapsuleTests COMMAND test_capsules)

# --- Includes (if using headers in include/) ---
target_include_directories(meralang PRIVATE ${CMAKE_SOURCE_DIR}/src)
target_include_directories(repl_ui PRIVATE ${CMAKE_SOURCE_DIR}/src)
target_include_directories(test_capsules PRIVATE ${CMAKE_SOURCE_DIR}/src)

# --- LLVM (optional, if using LLVM IR output) ---
find_package(LLVM REQUIRED CONFIG)
if(LLVM_FOUND)
    message(STATUS "Found LLVM ${LLVM_PACKAGE_VERSION}")
    target_include_directories(meralang PRIVATE ${LLVM_INCLUDE_DIRS})
    target_link_directories(meralang PRIVATE ${LLVM_LIBRARY_DIRS})
    target_compile_definitions(meralang PRIVATE ${LLVM_DEFINITIONS})
    llvm_map_components_to_libnames(llvm_libs support core irreader)
    target_link_libraries(meralang PRIVATE ${llvm_libs})
endif()

# --- Install targets (optional) ---
install(TARGETS meralang repl_ui test_capsules
        RUNTIME DESTINATION bin)

# --- Output directory ---
set_target_properties(meralang repl_ui test_capsules
    PROPERTIES
    RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin
)
