cmake_minimum_required(VERSION 3.14)
project(KeyLimeLW VERSION 0.1 LANGUAGES CXX
    DESCRIPTION "Key Lime LW: Lightweight MeraLang Capsule Compiler"
)

# --- C++ Standard ---
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# --- Output directories ---
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin)
set(CMAKE_LIBRARY_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)

# --- Optional features ---
option(ENABLE_SYMBOLIC_TRACE "Enable symbolic tracing" ON)
option(ENABLE_DLMT_FASTPATH "Enable DLMT fastpath" OFF)
option(ENABLE_SAN_EMITTER "Enable SAN emitter" ON)
option(ENABLE_DLMT_MAPPER "Enable DLMT mapper" ON)
option(ENABLE_DG_TRACER "Enable DG tracer" ON)

# --- Source files ---
file(GLOB_RECURSE SOURCES src/*.cpp include/*.h)

# --- Main executable ---
add_executable(keylime
    src/main.cpp
    src/lexer.cpp
    src/parser.cpp
    $<$<BOOL:${ENABLE_SAN_EMITTER}>:src/san_emitter.cpp>
    $<$<BOOL:${ENABLE_DLMT_MAPPER}>:src/dlmt_mapper.cpp>
    $<$<BOOL:${ENABLE_DG_TRACER}>:src/dg_tracer.cpp>
    src/capsule_runner.cpp
)

target_include_directories(keylime PRIVATE include)

# --- Conditional flags ---
if(ENABLE_SYMBOLIC_TRACE)
    target_compile_definitions(keylime PRIVATE DG_TRACE_ENABLED=1)
endif()

if(ENABLE_DLMT_FASTPATH)
    target_compile_definitions(keylime PRIVATE DLMT_FASTPATH=1)
endif()

# --- Tests ---
enable_testing()
add_subdirectory(tests)

# --- Install examples and headers ---
install(DIRECTORY examples/ DESTINATION share/keylimelw/examples)
install(DIRECTORY include/ DESTINATION include/keylimelw)

# --- Install binary ---
install(TARGETS keylime DESTINATION bin)

# --- Packaging ---
set(CPACK_PACKAGE_NAME "KeyLimeLW")
set(CPACK_PACKAGE_VERSION "0.1")
set(CPACK_PACKAGE_DESCRIPTION "Key Lime LW: Lightweight MeraLang Capsule Compiler")
set(CPACK_GENERATOR "ZIP;TGZ")
include(CPack)
